sudo: required

language: python
python:
  - "3.7"

env:
  - POSTGRES_HOST=postgres
  - POSTGRES_PORT=5432
  - POSTGRES_USER=postgres
  - POSTGRES_PASSWORD=postgres
  - POSTGRES_DB=postgres

services:
  - docker

install:
  - pip install -r requirements.txt

script:
  - docker build -t logistics-index .
  - docker run --rm logistics-index -m pytest tests/unit -vv
  - docker run --rm logistics-index -m flake8 src
  - docker run --rm -d --name=logistics-index-web \
    -p 5000:5000 \
    -e POSTGRES_USER=${POSTGRES_USER} \
    -e POSTGRES_PASSWORD=${POSTGRES_PASSWORD} \
    -e POSTGRES_HOST=${POSTGRES_HOST} \
    -e POSTGRES_PORT=${POSTGRES_PORT} \
    -e POSTGRES_DB=${POSTGRES_DB} \
    logistics-index
  - curl -I -f localhost:5000

after_script:
  - docker stop logistics-index-web